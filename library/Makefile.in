#  Copyright (c) 2012 Matthew Mitchell
#
#  This file is part of cbitcoin. It is subject to the license terms
#  in the LICENSE file found in the top-level directory of this
#  distribution and at http://www.cbitcoin.com/license.html. No part of
#  cbitcoin, including this file, may be copied, modified, propagated,
#  or distributed except according to the terms contained in the
#  LICENSE file.


# Flags

INCDIR = $(CURDIR)/include
BINDIR = $(CURDIR)/bin
CFLAGS += -Wall -Wno-uninitialized -Wno-pointer-to-int-cast -pedantic -std=gnu99 -I$(INCDIR) -I/opt/local/ssl/include -I/opt/local/include -I$(CURDIR)/dependencies/threads -Werror 
LFLAGS = -L/opt/local/lib -L/usr/local/ssl/lib
ifndef OSTYPE
  OSTYPE = $(shell uname -s|awk '{print tolower($$0)}')
  #export OSTYPE
endif
LIBRARY_VERSION = 2.0
ifeq ($(OSTYPE), darwin)
	LFLAGS += -flat_namespace -dynamiclib -undefined dynamic_lookup
	LIBRARY_EXTENSION=.$(LIBRARY_VERSION).dylib
else # Assuming Linux for now
	LFLAGS += -shared
	LIBRARY_EXTENSION=.$(LIBRARY_VERSION).so
	ADDITIONAL_OPENSSL_FLAGS = -ldl -L/lib/x86_64-linux-gnu/
	export LD_LIBRARY_PATH = $(BINDIR):/usr/local/lib
endif
LIBCFLAGS = @LIB_COMPILE_CONFIG_FLAGS@

# Directory names

# Set vpath search paths

vpath %.h include
vpath %.c src
vpath %.o build
vpath %.d build

# Non-debugging

all: CFLAGS += -O3
all: all-build

test: CFLAGS += -O3
test: test-build

# Debugging

debug-all: CFLAGS += -g
debug-all: all-build

debug-test: CFLAGS += -g
debug-test: test-build

# Build all

all-build: core crypto random threads logging network storage file-ec file-no-ec 

# Get files for the core library

CORE_FILES = $(wildcard src/*.c)
CORE_OBJS = $(patsubst src/%.c, build/%.o, $(CORE_FILES))

# Core library target linking

core : $(CORE_OBJS) | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin$(LIBRARY_EXTENSION) $(CORE_OBJS)

# Include header prerequisites

-include build/*.d

# Create build directory

build:
	mkdir build

# Create bin directory

bin:
	mkdir bin

# Core Compilation

$(CORE_OBJS): build/%.o: src/%.c | build
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@
	$(CC) -I$(INCDIR) -MM $< > build/$*.d
	@cp build/$*.d build/$*.P
	@sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' \
            -e '/^$$/ d' -e 's/$$/ :/' < build/$*.P >> build/$*.d;
	@rm build/$*.P

# Dependencies require include/CBDependencies.h as a prerequisite

build/CBOpenSSLCrypto.o build/CBRand.o CBBlockChainStorage.o BLibEventSockets.o: include/CBDependencies.h

# Crypto library target linking

crypto : build/CBOpenSSLCrypto.o | bin
	$(CC) $(LFLAGS) $(ADDITIONAL_OPENSSL_FLAGS) -o bin/libcbitcoin-crypto$(LIBRARY_EXTENSION) build/CBOpenSSLCrypto.o -lcrypto -lssl

# Crypto library compile

build/CBOpenSSLCrypto.o: dependencies/crypto/CBOpenSSLCrypto.c
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# Random library target linking

random : build/CBRand.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-rand$(LIBRARY_EXTENSION) build/CBRand.o

# Random library compile

build/CBRand.o: dependencies/random/CBRand.c
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# Network library target linking

network : build/CBLibEventSockets.o build/CBCallbackQueue.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-network$(LIBRARY_EXTENSION) build/CBLibEventSockets.o build/CBCallbackQueue.o -levent_core

# Network library compile

build/CBCallbackQueue.o: dependencies/sockets/CBCallbackQueue.c dependencies/sockets/CBCallbackQueue.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBLibEventSockets.o: dependencies/sockets/CBLibEventSockets.c dependencies/sockets/CBLibEventSockets.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@
	
# Threads library target linking

threads : build/CBThreads.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-threads$(LIBRARY_EXTENSION) build/CBThreads.o

# Threads library compile

build/CBThreads.o: dependencies/threads/CBThreads.c dependencies/threads/CBThreads.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# Logging library target linking

logging : build/CBLog.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-logging$(LIBRARY_EXTENSION) build/CBLog.o

# Logging library compile

build/CBLog.o: dependencies/logging/CBLog.c dependencies/logging/CBLog.h 
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# File IO library target linking

file-ec : build/CBFileEC.o build/CBHamming72.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-file-ec$(LIBRARY_EXTENSION) build/CBFileEC.o build/CBHamming72.o

file-no-ec : build/CBFileNoEC.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-file-no-ec$(LIBRARY_EXTENSION) build/CBFileNoEC.o

# File IO library compile

build/CBHamming72.o: dependencies/storage/CBHamming72.c dependencies/storage/CBHamming72.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBFileEC.o: dependencies/storage/CBFileEC.c dependencies/storage/CBFileEC.h dependencies/storage/CBHamming72.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBFileNoEC.o: dependencies/storage/CBFileNoEC.c dependencies/storage/CBFileNoEC.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# Storage library files

STORAGE_FILES = $(wildcard dependencies/storage/*.c)
STORAGE_OBJS = $(patsubst dependencies/storage/%.c, build/%.o, $(STORAGE_FILES))

# Storage library target linking

storage : build/CBBlockChainStorage.o build/CBAddressStorage.o build/CBDatabase.o build/CBAccounterStorage.o build/CBNodeStorage.o | bin
	$(CC) $(LFLAGS) -o bin/libcbitcoin-storage$(LIBRARY_EXTENSION) build/CBBlockChainStorage.o build/CBAddressStorage.o build/CBDatabase.o build/CBAccounterStorage.o build/CBNodeStorage.o

# Storage library compile

build/CBAccounterStorage.o: dependencies/storage/CBAccounterStorage.c dependencies/storage/CBAccounterStorage.h dependencies/storage/CBDatabase.h 
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBAddressStorage.o: dependencies/storage/CBAddressStorage.c dependencies/storage/CBAddressStorage.h dependencies/storage/CBDatabase.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBBlockChainStorage.o: dependencies/storage/CBBlockChainStorage.c dependencies/storage/CBBlockChainStorage.h dependencies/storage/CBDatabase.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBNodeStorage.o: dependencies/storage/CBNodeStorage.c dependencies/storage/CBNodeStorage.h dependencies/storage/CBDatabase.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

build/CBDatabase.o: dependencies/storage/CBDatabase.c dependencies/storage/CBDatabase.h
	$(CC) -c $(CFLAGS) $(LIBCFLAGS) $< -o $@

# Clean

clean:
	rm -f -r build bin

# Tests

TEST_FILES = $(wildcard test/*.c)
TEST_BINARIES = $(patsubst test/%.c, bin/%, $(TEST_FILES))
TEST_OBJS = $(patsubst test/%.c, build/%.o, $(TEST_FILES))

test-build : all-build $(TEST_BINARIES)
	rm -f -r cbitcoin 0 1 2

# REMEMBER to add dependencies after the objects or libraries that depend on them.

$(TEST_BINARIES): bin/%: build/%.o
	$(CC) $< -L$(BINDIR) -lcbitcoin.$(LIBRARY_VERSION) -lcbitcoin-network.$(LIBRARY_VERSION) -lcbitcoin-storage.$(LIBRARY_VERSION) -lcbitcoin-threads.$(LIBRARY_VERSION) -lcbitcoin-logging.$(LIBRARY_VERSION) -lcbitcoin-crypto.$(LIBRARY_VERSION) -lcbitcoin.$(LIBRARY_VERSION) -lcbitcoin-file-ec.$(LIBRARY_VERSION) -lcbitcoin-rand.$(LIBRARY_VERSION) -L/opt/local/lib -lpthread -levent_core -levent_pthreads -lcrypto -o $@
	$@

$(TEST_OBJS): build/%.o: test/%.c
	$(CC) -c $(CFLAGS) -I$(CURDIR)/dependencies/sockets/ -I$(CURDIR)/dependencies/storage $< -o $@
	